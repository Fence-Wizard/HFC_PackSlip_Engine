<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pack Slip Engine • Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Top Nav -->
  <header class="border-b bg-white/70 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-slate-900 text-white flex items-center justify-center font-semibold">PS</div>
        <div>
          <div class="font-semibold leading-tight">Pack Slip Engine</div>
          <div class="text-xs text-slate-500">Upload → Review → Submit</div>
        </div>
      </div>
      <a href="/upload.html" class="text-sm text-slate-600 hover:text-slate-900">New upload</a>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-10">
    <div class="grid gap-6 lg:grid-cols-2 items-start">
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h1 class="text-xl font-semibold">Upload a pack slip</h1>
        <p class="mt-2 text-sm text-slate-600">
          Drop a PDF or image. We’ll extract text and prepare it for confirmation.
        </p>

        <!-- Vendor Selection -->
        <div class="mt-6">
          <label for="vendorSelect" class="block text-sm font-medium text-slate-700 mb-2">
            Vendor <span class="text-slate-400">(optional - auto-detect if blank)</span>
          </label>
          <select id="vendorSelect" class="w-full px-3 py-2 border border-slate-300 rounded-xl bg-white focus:ring-2 focus:ring-slate-900/20 focus:border-slate-400">
            <option value="">Auto-detect vendor</option>
            <!-- Options loaded dynamically -->
          </select>
        </div>

        <!-- Dropzone -->
        <div id="dropzone"
             class="mt-4 rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 hover:bg-slate-100/60 transition p-8 text-center cursor-pointer">
          <div class="mx-auto w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center">
            ⬆️
          </div>
          <div class="mt-3 font-medium">Drag & drop your file here</div>
          <div class="text-sm text-slate-500 mt-1">or click to choose a file</div>
          <div class="text-xs text-slate-400 mt-3">Supported: PDF, PNG, JPG • Recommended under 15MB for MVP</div>

          <input id="fileInput" type="file" class="hidden" accept="application/pdf,image/*" />
        </div>

        <!-- Selected -->
        <div id="selected" class="mt-4 hidden">
          <div class="flex items-center justify-between gap-3 bg-slate-50 border border-slate-200 rounded-xl p-3">
            <div class="min-w-0">
              <div class="text-sm font-medium truncate" id="fileName"></div>
              <div class="text-xs text-slate-500" id="fileMeta"></div>
            </div>
            <button id="clearBtn" class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-white text-sm">
              Clear
            </button>
          </div>

          <!-- Progress -->
          <div class="mt-3">
            <div class="flex items-center justify-between text-xs text-slate-600">
              <span>Upload progress</span>
              <span id="pct">0%</span>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-200 overflow-hidden">
              <div id="bar" class="h-2 bg-slate-900 w-0 transition-all"></div>
            </div>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="uploadBtn"
              class="flex-1 px-4 py-2.5 rounded-xl bg-slate-900 hover:bg-slate-800 text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              Upload & Review
            </button>
          </div>
        </div>
      </section>

      <aside class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="font-semibold">What happens next?</h2>
        <ol class="mt-3 space-y-3 text-sm text-slate-600">
          <li class="flex gap-3">
            <span class="mt-0.5 w-6 h-6 rounded-lg bg-slate-900 text-white flex items-center justify-center text-xs">1</span>
            <span>We extract text from the PDF (or OCR an image).</span>
          </li>
          <li class="flex gap-3">
            <span class="mt-0.5 w-6 h-6 rounded-lg bg-slate-900 text-white flex items-center justify-center text-xs">2</span>
            <span>You review and confirm the items received.</span>
          </li>
          <li class="flex gap-3">
            <span class="mt-0.5 w-6 h-6 rounded-lg bg-slate-900 text-white flex items-center justify-center text-xs">3</span>
            <span>On submit, we send structured data to n8n for email + Slack posting.</span>
          </li>
        </ol>

        <div class="mt-6 p-4 rounded-2xl bg-slate-50 border border-slate-200">
          <div class="text-sm font-medium">Tip</div>
          <div class="mt-1 text-sm text-slate-600">
            Start with a clear photo: good lighting, flat page, minimal blur.
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script type="module">
    import { toast } from "/assets/ui.js";
    import { uploadFile, apiGet } from "/assets/api.js";

    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const selected = document.getElementById("selected");
    const fileName = document.getElementById("fileName");
    const fileMeta = document.getElementById("fileMeta");
    const uploadBtn = document.getElementById("uploadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const pct = document.getElementById("pct");
    const bar = document.getElementById("bar");
    const vendorSelect = document.getElementById("vendorSelect");

    let file = null;

    // Load vendors on page load
    async function loadVendors() {
      try {
        const data = await apiGet("/api/vendors");
        if (data?.vendors) {
          // Add separator for vendors with profiles
          const withProfile = data.vendors.filter(v => v.hasProfile);
          const withoutProfile = data.vendors.filter(v => !v.hasProfile);
          
          if (withProfile.length > 0) {
            const optGroup1 = document.createElement("optgroup");
            optGroup1.label = "— Vendors with parsing profiles —";
            withProfile.forEach(v => {
              const opt = document.createElement("option");
              opt.value = v.id;
              opt.textContent = v.name + " ✓";
              optGroup1.appendChild(opt);
            });
            vendorSelect.appendChild(optGroup1);
          }
          
          if (withoutProfile.length > 0) {
            const optGroup2 = document.createElement("optgroup");
            optGroup2.label = "— Other vendors (generic parser) —";
            withoutProfile.forEach(v => {
              const opt = document.createElement("option");
              opt.value = v.id;
              opt.textContent = v.name;
              optGroup2.appendChild(opt);
            });
            vendorSelect.appendChild(optGroup2);
          }
          
          // Add manual option at the end
          const manualOpt = document.createElement("option");
          manualOpt.value = "_manual";
          manualOpt.textContent = "⚠️ Unknown / Other Vendor";
          vendorSelect.appendChild(manualOpt);
        }
      } catch (err) {
        console.error("Failed to load vendors:", err);
      }
    }
    loadVendors();

    function setFile(f) {
      file = f;
      if (!file) {
        selected.classList.add("hidden");
        dropzone.classList.remove("hidden");
        return;
      }
      dropzone.classList.remove("hidden");
      selected.classList.remove("hidden");
      fileName.textContent = file.name;
      fileMeta.textContent = `${(file.size/1024/1024).toFixed(2)} MB • ${file.type || "unknown type"}`;
      pct.textContent = "0%";
      bar.style.width = "0%";
    }

    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("ring-2", "ring-slate-900/30");
    });
    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("ring-2", "ring-slate-900/30");
    });
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("ring-2", "ring-slate-900/30");
      const f = e.dataTransfer.files?.[0];
      if (!f) return;
      if (!isAllowed(f)) return toast("Please upload a PDF or image file.", "warning");
      setFile(f);
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      if (!isAllowed(f)) return toast("Please upload a PDF or image file.", "warning");
      setFile(f);
    });

    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      setFile(null);
    });

    function isAllowed(f) {
      return f.type === "application/pdf" || (f.type && f.type.startsWith("image/")) || f.name.toLowerCase().endsWith(".pdf");
    }

    uploadBtn.addEventListener("click", async () => {
      if (!file) return toast("Choose a file first.", "warning");
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading…";
      try {
        // Include vendor in upload
        const vendorId = vendorSelect.value || "";
        const res = await uploadFile("/api/upload", file, (p) => {
          pct.textContent = `${p}%`;
          bar.style.width = `${p}%`;
        }, { vendorId });
        if (!res?.id) throw new Error("Upload succeeded but no id returned.");
        toast("Uploaded. Redirecting to review…", "success");
        window.location.href = `/review.html?id=${encodeURIComponent(res.id)}`;
      } catch (e) {
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload & Review";
      }
    });

    setFile(null);
  </script>
</body>
</html>

